<!DOCTYPE html>
<html>
<head>
    <title>Population Simulation Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .charts-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .chart {
            flex: 1;
            min-width: 300px;
            height: 400px;
        }
        .chart > div {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <h1>Population Simulation Dashboard</h1>

    <!-- Dropdown to select scenario -->
    <label for="scenario-select">Select Scenario:</label>
    <select id="scenario-select"></select>

    <!-- First row of charts -->
    <div class="charts-row">
        <div class="chart" id="population-trend"></div>
        <div class="chart" id="population-breakdown"></div>
        <div class="chart" id="immigrant-percentage"></div>
    </div>

    <!-- Additional charts -->
    <div class="chart" id="fertility-chart" style="height:400px;"></div>
    <div class="chart" id="age-sex-pyramid" style="height:400px;"></div>
    <div class="chart" id="immigrant-gene-histogram" style="height:400px;"></div>

    <script>
    let globalData = {};
    let selectedScenario;

    // Fetch all scenario data
    fetch('all_scenarios_data.json')
        .then(response => response.json())
        .then(data => {
            globalData = data;
            const scenarioSelect = document.getElementById('scenario-select');

            // Populate the dropdown with scenario keys
            Object.keys(data).forEach(scenarioKey => {
                const option = document.createElement('option');
                option.value = scenarioKey;
                option.textContent = `Scenario ${scenarioKey}`;
                scenarioSelect.appendChild(option);
            });

            // Set initial scenario and render data
            selectedScenario = Object.keys(data)[0];
            renderScenario(selectedScenario);

            // Event listener for scenario change
            scenarioSelect.addEventListener('change', (event) => {
                selectedScenario = event.target.value;
                renderScenario(selectedScenario);
            });
        })
        .catch(error => console.error('Error loading data:', error));

    function renderScenario(scenarioKey) {
        const data = globalData[scenarioKey];
        if (!data) return;

        // Total Population Trend with Min/Max Band
        const totalPopTraces = [
            { x: data.years, y: data.minTotalPopulation, mode: 'lines', line: { width: 0, color: 'green' }, showlegend: false },
            { x: data.years, y: data.maxTotalPopulation, mode: 'lines', fill: 'tonexty', fillcolor: 'rgba(0,128,0,0.2)', line: { width: 0, color: 'green' }, showlegend: false },
            { x: data.years, y: data.totalPopulation, mode: 'lines+markers', name: 'Avg Total Population', line: { color: 'green', width: 2 } }
        ];
        Plotly.newPlot('population-trend', totalPopTraces, { title: 'Total Population Over Time', xaxis: { title: 'Year' }, yaxis: { title: 'Population' } });

        // Population Breakdown
        Plotly.newPlot('population-breakdown', [
            { x: data.years, y: data.nativePopulation, mode: 'lines', name: 'Native', line: { color: 'blue' } },
            { x: data.years, y: data.immigrant1Population, mode: 'lines', name: 'Immigrant 1', line: { color: 'red' } },
            { x: data.years, y: data.immigrant2Population, mode: 'lines', name: 'Immigrant 2', line: { color: 'orange' } },
            { x: data.years, y: data.mixedPopulation, mode: 'lines', name: 'Mixed', line: { color: 'purple' } }
        ], { title: 'Population Breakdown Over Time', xaxis: { title: 'Year' }, yaxis: { title: 'Population' } });

        // Immigrant Percentage Over Time
        Plotly.newPlot('immigrant-percentage', [{ x: data.years, y: data.immigrantPercentage, mode: 'lines', name: 'Immigrant %', line: { color: 'orange' } }], {
            title: 'Immigrant Percentage Over Time',
            xaxis: { title: 'Year' }, yaxis: { title: 'Percentage (%)' }
        });

        // Fertility Chart
        Plotly.newPlot('fertility-chart', [
            { x: data.years, y: data.avgChildrenPerFemaleNatives, mode: 'lines', name: 'Native Females', line: { color: 'blue' } },
            { x: data.years, y: data.avgChildrenPerFemaleImmigrants, mode: 'lines', name: 'Immigrant Females', line: { color: 'red' } },
            { x: data.years, y: data.avgChildrenPerFemaleMixed, mode: 'lines', name: 'Mixed Females', line: { color: 'purple' } }
        ], { title: 'Average Children per Female', xaxis: { title: 'Year' }, yaxis: { title: 'Avg Children' } });

        // Initial Pyramid and Histogram
        updatePyramidAndHistogram(0, data);

        // Update Pyramid on Hover
        document.getElementById('population-trend').on('plotly_hover', function(event) {
            if (event && event.points && event.points.length > 0) {
                updatePyramidAndHistogram(event.points[0].x, data);
            }
        });
    }

    function updatePyramidAndHistogram(year, data) {
        const pyramidData = data.pyramidData[year];
        if (pyramidData) {
            const ageSexData = [
                { y: pyramidData.ageGroups, x: pyramidData.nativeMaleCounts, type: 'bar', name: 'Native Males', orientation: 'h', marker: { color: 'blue' } },
                { y: pyramidData.ageGroups, x: pyramidData.immigrantMaleCounts, type: 'bar', name: 'Immigrant Males', orientation: 'h', marker: { color: 'lightblue' } },
                { y: pyramidData.ageGroups, x: pyramidData.nativeFemaleCounts, type: 'bar', name: 'Native Females', orientation: 'h', marker: { color: 'red' } },
                { y: pyramidData.ageGroups, x: pyramidData.immigrantFemaleCounts, type: 'bar', name: 'Immigrant Females', orientation: 'h', marker: { color: 'pink' } }
            ];
            Plotly.react('age-sex-pyramid', ageSexData, { title: `Age-Sex Pyramid (Year ${year})`, barmode: 'relative', xaxis: { title: 'Population' }, yaxis: { autorange: 'reversed' } });
        }
    }
    </script>
</body>
</html>
